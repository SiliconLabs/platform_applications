# Baremetal TRNG Example #
![Type badge](https://img.shields.io/badge/dynamic/json?url=https://raw.githubusercontent.com/SiliconLabs/application_examples_ci/master/platform_applications/platform_trng_common.json&label=Type&query=type&color=green)
![Technology badge](https://img.shields.io/badge/dynamic/json?url=https://raw.githubusercontent.com/SiliconLabs/application_examples_ci/master/platform_applications/platform_trng_common.json&label=Technology&query=technology&color=green)
![License badge](https://img.shields.io/badge/dynamic/json?url=https://raw.githubusercontent.com/SiliconLabs/application_examples_ci/master/platform_applications/platform_trng_common.json&label=License&query=license&color=green)
![SDK badge](https://img.shields.io/badge/dynamic/json?url=https://raw.githubusercontent.com/SiliconLabs/application_examples_ci/master/platform_applications/platform_trng_common.json&label=SDK&query=sdk&color=green)
![Build badge](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/SiliconLabs/application_examples_ci/master/platform_applications/platform_trng_build_status.json)

## Summary ##
This project uses the TRNG peripheral of the EFM32GG11 to generate random numbers.

## Peripherals Used ##
- TRNG
- USART

> It is highly recommended to use the [software libraries](https://docs.silabs.com/mbed-tls/latest/group-rng-module) provided by Silicon Labs to acces the TRNG module. This example should serve as a reference for users that choose to write their own low-level drivers.

## Gecko SDK version ##
v3.1.1

## Hardware Required ##
- [One SLSTK3701A Giant Gecko GG11 Starter Kit](https://www.silabs.com/products/development-tools/mcu/32-bit/efm32-giant-gecko-gg11-starter-kit)

## Setup from scratch ##
Open Simplicity Studio v5 and create a new `Empty C Project`.

In the `.slcp` file go to the `Software Components` tab and add the following components:
  
- [Services] > [IO Stream] > [IO Stream: USART] (you will need to name an instance of this component, e.g. "vcom")
- [Third Party] > [Tiny Printf]
- [Services] > [Microsecond Delay]

Next find the `[Platform] > [Board] > [Board Control]` component and click on the configuration icon. In the `Board Control` configuration page ensure that `Enable Virtual COM UART` is toggled on.

Ensure that the [IO Stream: USART component] is configured appropriately by located the instance of [Services] > [IO Stream] > [IO Stream: USART] you added (i.e. "vcom"). Click on the associate gear icon to open the component configuration window and ensure that the selected module is USART4, the RX pin is PH5, and the TX pin is PH4.

Lastly replace the `app.c` generated by Simplicity Studio with the one in [this repo](src/app.c).

## Setup from .sls import ##
Clone the repository with this project from Github to your local machine.

Import the included .sls file to Studio then build and flash the project to the SLSTK3701A STK.
To do this open Simplicity Studio select "File->Import" and navigate to the directory with the .sls project file.

Open a serial terminal and connect to the J-Link CDC UART Port for the SLSTK3701A using 115200 baud, 8-bit data, 1 stop bit, no parity, and no flow control.

The values observed are generated from the TRNG.

```
0x419D99A4
0x52ECB07A
0xCA869285
0x96E03275
0xF07E9B30
0x94ED13A6
0xD1BBBE04
0xE810534B
0xF5EF2DB1
0x8196AE68
0xD7DEB454
0x4C4C1FA8
...
```

## How the Project Works ##
On startup a Conditioning Function test and Entropy Source Check are conducted.

Full output of the startup software tests can be viewed in [/docs/trng_console_out.txt](docs/trng_console_out.txt).

```
bare-metal TRNG example using ADC as entropy source

====================================================
Known-Answer Test for Conditioning Function
====================================================

Key               0x2B7E151628AED2A6ABF7158809CF4F3C

Input             0x6BC0BCE12A459991E134741A7F9E1925
                  0xAE2D8A571E03AC9C9EB76FAC45AF8E51
                  0x30C81C46A35CE411E5FBC1191A0A52EF
                  0xF69F2445DF4F9B17AD2B417BE66C3710

Expected Output   0x3FF1CAA1681FAC09120ECA307586E1A7
Received Output   0x3FF1CAA1681FAC09120ECA307586E1A7
====================================================
TRNG Condition Function Check -> PASSED
```

Once initialized the TRNG will continously fill a 64 x 32-bit FIFO with the generated values.
In the case where the FIFO is full the TRNG will automatically stop until the FIFO has been emptied.

The samples from the entropy source are continually monitored by 4 built in tests:
- AIS31 Noise Alarm
- Adaptive proportion test (4096-sample window)
- Adaptive proportion test (64-sample window)
- Repetition Count test

If these tests fail they trigger an interrupt which empties the TRNG FIFO and resets the peripheral.

## .sls Projects Used ##
gg11_trng.sls

## How to Port to Another Part ##
Open the .slcp and in the "Overview" tab select "Change Target/SDK". Choose the new board or part to target and "Apply" the changes. 
Note: There may be dependencies that need to be resolved when changing the target architecture.
